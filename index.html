<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utility Pole Assessment Map</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: Arial, sans-serif;
        }

        #map { 
            position: absolute; 
            top: 0; 
            bottom: 0; 
            width: 100%; 
        }
        .mapboxgl-popup-content {
            padding: 15px;
            max-width: 300px;
        }
        .popup-header {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }
        .popup-info {
            margin-bottom: 8px;
            font-size: 14px;
        }
        .popup-label {
            font-weight: bold;
            color: #666;
        }
        .audit-button {
            background-color: #007cbf;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-top: 10px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .audit-button:hover {
            background-color: #005a87;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .error {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #f5c6cb;
            z-index: 1000;
        }
        .stats {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 14px;
            z-index: 1000;
        }
        .stats-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        .refresh-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .refresh-button:hover {
            background-color: #218838;
        }
        
        /* User location marker styles */
        .user-location-marker {
            position: relative;
            width: 20px;
            height: 20px;
        }
        
        .user-location-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            background-color: #007cbf;
            border: 2px solid #ffffff;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 2;
        }
        
        .user-location-pulse {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background-color: #007cbf;
            border-radius: 50%;
            opacity: 0.3;
            animation: pulse 2s infinite;
            z-index: 1;
        }
        
        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.3;
            }
            70% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }
        
        /* Pole status legend styles */
        .pole-legend {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            font-size: 13px;
            z-index: 1000;
            min-width: 160px;
        }
        
        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            font-size: 14px;
            text-align: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        .legend-item:last-child {
            margin-bottom: 0;
        }
        
        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid #fff;
            margin-right: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .legend-item span {
            color: #333;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading" class="loading">Loading pole locations...</div>
    <div id="error" class="error" style="display: none;"></div>
    <div id="stats" class="stats">
        <div class="stats-title">Assessment Progress</div>
        <div id="total-poles">Total Poles: 0</div>
        <div id="pending-poles">Pending: 0</div>
        <div id="completed-poles">Completed: 0</div>
    </div>
    <button id="refresh-button" class="refresh-button" onclick="refreshData()">Refresh Data</button>

    <script>
        // Configuration
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiZmllbGRzZW5zZSIsImEiOiJjbWN4dW42eTcwZXJxMmxwdW41Y2JycjZ0In0.LpdOqXdOCP4TNamhlj8i-w';
        const FILLOUT_FORM_BASE_URL = 'https://form.fillout.com/t/qwmp3Zdh2fus';
        const GEOJSON_URL = 'https://raw.githubusercontent.com/dmend0za/Pole-Audit-Map/main/OsmoseRejectsMerge.geojson';
        const GOOGLE_SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/1KCReNtgnRafFIvnNE6XdrdgZFylxpTLJQ3wnmDNBJSg/export?format=csv';
        
        let map;
        let allPoles = [];
        let completedPoleIds = new Set();
        let currentPopup = null;
        let statusCheckInterval = null;
        let userLocationMarker = null;
        let watchId = null;

        // Initialize map
        function initializeMap() {
            try {
                mapboxgl.accessToken = MAPBOX_TOKEN;
                
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/satellite-streets-v12',
                    center: [-77.90, 35.71], // Centered on your pole area
                    zoom: 12,
                    attributionControl: true
                });

                map.on('load', function () {
                    document.getElementById('loading').style.display = 'none';
                    loadPoleData();
                    
                    // Request user location after map loads
                    requestUserLocation();
                    
                    // Add pole status legend after map loads
                    addPoleStatusLegend();
                });

                map.on('error', function(e) {
                    showError('Map failed to load: ' + e.error.message);
                });

            } catch (error) {
                showError('Failed to initialize map: ' + error.message);
            }
        }

        // Request and track user location
        function requestUserLocation() {
            if (!navigator.geolocation) {
                console.log('Geolocation is not supported by this browser');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    updateUserLocationMarker(position.coords);
                    watchUserLocation();
                },
                (error) => {
                    console.error('Error getting location:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        // Watch user location for continuous updates
        function watchUserLocation() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    updateUserLocationMarker(position.coords);
                },
                (error) => {
                    console.error('Error watching location:', error);
                },
                {
                    enableHighAccuracy: false,
                    timeout: 30000,
                    maximumAge: 300000
                }
            );
        }

        // Update or create user location marker
        function updateUserLocationMarker(coords) {
            const { latitude, longitude } = coords;
            
            if (userLocationMarker) {
                userLocationMarker.remove();
            }

            const userLocationElement = document.createElement('div');
            userLocationElement.className = 'user-location-marker';
            userLocationElement.innerHTML = `
                <div class="user-location-dot"></div>
                <div class="user-location-pulse"></div>
            `;

            userLocationMarker = new mapboxgl.Marker({
                element: userLocationElement,
                anchor: 'center'
            })
            .setLngLat([longitude, latitude])
            .addTo(map);

            if (!map.hasUserCentered) {
                map.flyTo({
                    center: [longitude, latitude],
                    zoom: 16,
                    duration: 2000
                });
                map.hasUserCentered = true;
            }
        }

        // Add pole status legend to the map
        function addPoleStatusLegend() {
            const legend = document.createElement('div');
            legend.id = 'pole-legend';
            legend.className = 'pole-legend';
            legend.innerHTML = `
                <div class="legend-title">Pole Status</div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #3498db;"></div>
                    <span>TRUSSED</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #f39c12;"></div>
                    <span>Restorable Reject</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e74c3c;"></div>
                    <span>Non Restorable</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #95a5a6;"></div>
                    <span>REPLACED</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #2ecc71;"></div>
                    <span>Pending Assessment</span>
                </div>
            `;
            
            document.getElementById('map').appendChild(legend);
        }

        // Load pole data from GeoJSON
        async function loadPoleData() {
            try {
                console.log('Loading pole data from:', GEOJSON_URL);
                const response = await fetch(GEOJSON_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Pole data loaded successfully:', data);
                
                if (!data.features || !Array.isArray(data.features)) {
                    throw new Error('Invalid GeoJSON format: features array not found');
                }
                
                allPoles = data.features;
                console.log(`Loaded ${allPoles.length} poles`);
                
                // Check completed poles from localStorage
                const stored = localStorage.getItem('completedPoles');
                if (stored) {
                    completedPoleIds = new Set(JSON.parse(stored));
                    console.log(`Found ${completedPoleIds.size} completed poles in local storage`);
                }
                
                addMarkersToMap();
                updateStats();
                startStatusChecking();
                
            } catch (error) {
                console.error('Error loading pole data:', error);
                showError('Failed to load pole data: ' + error.message);
            }
        }

        // Extract pole data from HTML description or properties
        function extractPoleData(pole) {
            const props = pole.properties;
            
            // Extract from HTML description if available
            let htmlString = '';
            if (props.description && typeof props.description === 'object') {
                htmlString = props.description.value || props.description;
            } else if (typeof props.description === 'string') {
                htmlString = props.description;
            }

            let data = {};
            
            if (htmlString) {
                // Parse HTML table data
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlString, 'text/html');
                const rows = doc.querySelectorAll('tr');
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length === 2) {
                        const key = cells[0].textContent.trim();
                        const value = cells[1].textContent.trim();
                        
                        switch(key) {
                            case 'Pole_Number':
                                data.poleNumber = value;
                                break;
                            case 'Length':
                                data.length = value;
                                break;
                            case 'Class':
                                data.class = value;
                                break;
                            case 'Year_Manufactured':
                                data.yearManufactured = value;
                                break;
                            case 'Status':
                                data.status = value;
                                break;
                            case 'URL':
                                const linkElement = cells[1].querySelector('a');
                                if (linkElement) {
                                    data.link = linkElement.getAttribute('href').replace(/&amp;/g, '&');
                                }
                                break;
                        }
                    }
                });
            }
            
            // Fall back to direct properties
            data.poleNumber = data.poleNumber || props.Pole_Number || props.name;
            data.length = data.length || props.Length;
            data.class = data.class || props.Class;
            data.yearManufactured = data.yearManufactured || props.Year_Manufactured;
            data.status = data.status || props.Status;
            data.link = data.link || props.URL;
            
            // Construct link if not available
            if (!data.link && data.poleNumber && data.length && data.class && data.yearManufactured && data.status) {
                const params = new URLSearchParams({
                    'Pole_ID': data.poleNumber,
                    'Length': data.length,
                    'Class': data.class,
                    'Year_Manu': data.yearManufactured,
                    'Status': data.status
                });
                data.link = `${FILLOUT_FORM_BASE_URL}?${params.toString()}`;
            }
            
            return data;
        }

        // Add markers to map
        function addMarkersToMap() {
            // Filter out completed poles
            const pendingPoles = allPoles.filter(pole => {
                const poleData = extractPoleData(pole);
                return !completedPoleIds.has(poleData.poleNumber);
            }).map(pole => {
                const poleData = extractPoleData(pole);
                return {
                    ...pole,
                    properties: {
                        ...pole.properties,
                        extractedStatus: poleData.status || 'Pending'
                    }
                };
            });

            const geojsonData = {
                type: 'FeatureCollection',
                features: pendingPoles
            };

            if (map.getSource('poles')) {
                map.getSource('poles').setData(geojsonData);
            } else {
                map.addSource('poles', {
                    type: 'geojson',
                    data: geojsonData,
                    cluster: true,
                    clusterMaxZoom: 14,
                    clusterRadius: 50
                });

                // Add cluster circles
                map.addLayer({
                    id: 'clusters',
                    type: 'circle',
                    source: 'poles',
                    filter: ['has', 'point_count'],
                    paint: {
                        'circle-color': [
                            'step',
                            ['get', 'point_count'],
                            '#51bbd6',
                            100,
                            '#f1c40f',
                            750,
                            '#f28cb1'
                        ],
                        'circle-radius': [
                            'step',
                            ['get', 'point_count'],
                            20,
                            100,
                            30,
                            750,
                            40
                        ]
                    }
                });

                // Add cluster count labels
                map.addLayer({
                    id: 'cluster-count',
                    type: 'symbol',
                    source: 'poles',
                    filter: ['has', 'point_count'],
                    layout: {
                        'text-field': '{point_count_abbreviated}',
                        'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                        'text-size': 12
                    }
                });

                // Add individual pole points with status-based colors
                map.addLayer({
                    id: 'unclustered-point',
                    type: 'circle',
                    source: 'poles',
                    filter: ['!', ['has', 'point_count']],
                    paint: {
                        'circle-color': [
                            'case',
                            ['==', ['get', 'extractedStatus'], 'TRUSSED'], '#3498db',
                            ['==', ['get', 'extractedStatus'], 'Restorable Reject'], '#f39c12',
                            ['==', ['get', 'extractedStatus'], 'Non Restorable Reject'], '#e74c3c',
                            ['==', ['get', 'extractedStatus'], 'REPLACED'], '#95a5a6',
                            '#2ecc71' // Default green for pending
                        ],
                        'circle-radius': 8,
                        'circle-stroke-width': 2,
                        'circle-stroke-color': '#ffffff'
                    }
                });

                // Add pole number labels
                map.addLayer({
                    id: 'pole-labels',
                    type: 'symbol',
                    source: 'poles',
                    filter: ['!', ['has', 'point_count']],
                    layout: {
                        'text-field': ['get', 'name'],
                        'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                        'text-size': 16,
                        'text-offset': [0, 2.2],
                        'text-anchor': 'top',
                        'text-allow-overlap': false,
                        'text-optional': true
                    },
                    paint: {
                        'text-color': '#1a1a1a',
                        'text-halo-color': '#ffffff',
                        'text-halo-width': 2
                    },
                    minzoom: 16
                });
            }

            setupClickHandlers();
        }

        // Setup click handlers
        function setupClickHandlers() {
            map.on('click', 'clusters', (e) => {
                const features = map.queryRenderedFeatures(e.point, {
                    layers: ['clusters']
                });
                const clusterId = features[0].properties.cluster_id;
                map.getSource('poles').getClusterExpansionZoom(
                    clusterId,
                    (err, zoom) => {
                        if (err) return;
                        map.easeTo({
                            center: features[0].geometry.coordinates,
                            zoom: zoom
                        });
                    }
                );
            });

            map.on('click', 'unclustered-point', (e) => {
                const pole = e.features[0];
                showPolePopup(pole, e.lngLat);
            });

            map.on('mouseenter', 'clusters', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'clusters', () => {
                map.getCanvas().style.cursor = '';
            });
            map.on('mouseenter', 'unclustered-point', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'unclustered-point', () => {
                map.getCanvas().style.cursor = '';
            });
        }

        // Show pole popup with details
        function showPolePopup(pole, coordinates) {
            const poleData = extractPoleData(pole);
            
            // Store pole data globally
            const dataKey = `poleData_${poleData.poleNumber}`;
            window[dataKey] = {
                name: poleData.poleNumber,
                link: poleData.link,
                timestamp: Date.now()
            };
            
            window.currentPoleData = window[dataKey];
            
            const popupContent = `
                <div class="popup-header">Pole ${poleData.poleNumber}</div>
                <div class="popup-info">
                    <span class="popup-label">Pole Number:</span> ${poleData.poleNumber || 'N/A'}
                </div>
                <div class="popup-info">
                    <span class="popup-label">Height:</span> ${poleData.length || 'N/A'}ft
                </div>
                <div class="popup-info">
                    <span class="popup-label">Class:</span> ${poleData.class || 'N/A'}
                </div>
                <div class="popup-info">
                    <span class="popup-label">Year Manufactured:</span> ${poleData.yearManufactured || 'N/A'}
                </div>
                <div class="popup-info">
                    <span class="popup-label">Status:</span> ${poleData.status || 'N/A'}
                </div>
                <button class="audit-button" onclick="startAssessmentWithId('${poleData.poleNumber}');">
                    Start Assessment
                </button>
            `;

            if (currentPopup) {
                currentPopup.remove();
            }

            currentPopup = new mapboxgl.Popup({
                closeOnClick: true,
                closeButton: true
            })
            .setLngLat(coordinates)
            .setHTML(popupContent)
            .addTo(map);

            currentPopup.on('close', () => {
                currentPopup = null;
            });
        }

        // Start assessment with pole ID
        function startAssessmentWithId(poleId) {
            const dataKey = `poleData_${poleId}`;
            let poleData = window[dataKey];
            
            if (!poleData) {
                poleData = window.currentPoleData;
            }
            
            if (!poleData) {
                showError('No pole data available. Please close and reopen the marker popup.');
                return;
            }
            
            const assessmentLink = poleData.link;
            
            if (!assessmentLink || !assessmentLink.startsWith('https://form.fillout.com')) {
                showError('Unable to generate assessment link for this pole.');
                return;
            }
            
            if (currentPopup) {
                currentPopup.remove();
                currentPopup = null;
            }
            
            try {
                window.open(assessmentLink, '_blank');
            } catch (error) {
                showError('Error opening assessment form: ' + error.message);
            }
        }

        // Check Google Sheets for completed assessments
        async function checkCompletedAssessments() {
            try {
                const response = await fetch(GOOGLE_SHEETS_CSV_URL);
                
                if (!response.ok) {
                    return;
                }
                
                const csvData = await response.text();
                const lines = csvData.split('\n');
                
                if (lines.length < 2) {
                    return;
                }
                
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const poleIdIndex = headers.findIndex(h => 
                    h.toLowerCase().includes('pole') && h.toLowerCase().includes('id')
                );
                const statusIndex = headers.findIndex(h => 
                    h.toLowerCase().includes('status')
                );
                
                if (poleIdIndex === -1 || statusIndex === -1) {
                    return;
                }
                
                const currentlyCompleted = new Set();
                
                for (let i = 1; i < lines.length; i++) {
                    const row = lines[i].split(',').map(cell => cell.trim().replace(/"/g, ''));
                    
                    if (row.length > Math.max(poleIdIndex, statusIndex)) {
                        const poleId = row[poleIdIndex];
                        const status = row[statusIndex];
                        
                        if (poleId && status && status.toLowerCase() === 'complete') {
                            currentlyCompleted.add(poleId);
                        }
                    }
                }
                
                const newCompletions = [...currentlyCompleted].filter(pole => !completedPoleIds.has(pole));
                const noLongerCompleted = [...completedPoleIds].filter(pole => !currentlyCompleted.has(pole));
                
                let mapNeedsUpdate = false;
                
                if (newCompletions.length > 0) {
                    newCompletions.forEach(pole => completedPoleIds.add(pole));
                    mapNeedsUpdate = true;
                    showInfo(`${newCompletions.length} assessment(s) completed! Markers removed.`);
                }
                
                if (noLongerCompleted.length > 0) {
                    noLongerCompleted.forEach(pole => completedPoleIds.delete(pole));
                    mapNeedsUpdate = true;
                    showInfo(`${noLongerCompleted.length} pole(s) status changed. Markers restored.`);
                }
                
                if (mapNeedsUpdate) {
                    localStorage.setItem('completedPoles', JSON.stringify([...completedPoleIds]));
                    addMarkersToMap();
                    updateStats();
                }
                
            } catch (error) {
                console.error('Error checking completed assessments:', error);
            }
        }

        // Start periodic status checking
        function startStatusChecking() {
            checkCompletedAssessments();
            
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            statusCheckInterval = setInterval(() => {
                checkCompletedAssessments();
            }, 30000);
        }

        // Update statistics
        function updateStats() {
            const total = allPoles.length;
            const completed = completedPoleIds.size;
            const pending = total - completed;
            
            document.getElementById('total-poles').textContent = `Total Poles: ${total}`;
            document.getElementById('pending-poles').textContent = `Pending: ${pending}`;
            document.getElementById('completed-poles').textContent = `Completed: ${completed}`;
        }

        // Refresh data
        function refreshData() {
            document.getElementById('loading').style.display = 'block';
            checkCompletedAssessments();
            loadPoleData();
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.style.backgroundColor = '#f8d7da';
            errorDiv.style.color = '#721c24';
            document.getElementById('loading').style.display = 'none';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 10000);
        }

        // Show info message
        function showInfo(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.style.backgroundColor = '#d4edda';
            errorDiv.style.color = '#155724';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            if (typeof mapboxgl !== 'undefined') {
                initializeMap();
            } else {
                showError('Mapbox GL JS failed to load. Please check your internet connection.');
            }
        });

        // Handle offline/online events
        window.addEventListener('online', function() {
            refreshData();
        });

        window.addEventListener('offline', function() {
            showError('You are currently offline. Some features may not work properly.');
        });

        // Clean up intervals when page unloads
        window.addEventListener('beforeunload', function() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
        });
    </script>
</body>
</html>
